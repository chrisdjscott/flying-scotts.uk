{% extends "layout.html" %}

{% block head %}
    {{ super() }}

    <!-- Leaflet CSS and JavaScript -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.3.1/gpx.min.js" type="text/javascript"></script>

    <!-- Leaflet Marker Cluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css"/>
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js" type="text/javascript"></script>

    <!-- Leaflet Photo -->
    <link href="{{ '/static/Leaflet.Photo/Leaflet.Photo.min.css'|asseturl }}" rel="stylesheet">
    <script src="{{ '/static/Leaflet.Photo/Leaflet.Photo.min.js'|asseturl }}" type="text/javascript"></script>

    <!-- Leaflet Fullscreen -->
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />

    <!-- Custom map CSS -->
    <link href="{{ '/static/css/map.min.css'|asseturl }}" rel="stylesheet">
{% endblock head %}

{% block background %}{% if this.image.startswith('https') %}{{ this.image }}{% else %}{{ this.image|url }}{% endif %}{% endblock %}

{% block heading %}
    <div class="post-heading">
        <h1>{{ this.title }}</h1>
        <h2 class="subheading">{% if this.description %}{{ this.description }}{% endif %}</h2>
        <span class="meta">{% if this.date %}{{ this.date|dateformat('d MMMM y') }}{% endif %}</span>
    </div>
{% endblock heading %}

{% block content %}
    {{ super() }}

    {% if this.gpx or (this.latitude and this.longitude) %}
        <!-- Map of the route -->
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-8 col-md-10 mx-auto">
                    <hr>
                    <section id="post-route" class="gpx" {% if this.gpx %}data-gpx-source="{{ this.gpx|url }}" {% endif %}data-map-target="post-map">
                        <header>
                            <h3>Loading...</h3>
                            <span class="start"></span>
                        </header>

                        <article>
                            <div class="map" id="post-map"></div>
                        </article>

                        {% if this.gpx %}
                            <footer>
                                <ul class="info">
                                    <li>Distance:&nbsp;<span class="distance"></span>&nbsp;km</li>
                                    &mdash; <li>Elapsed:&nbsp;<span class="elapsed"></span></li>
                                    &mdash; <li>Moving:&nbsp;<span class="moving"></span></li>
                                    &mdash; <li>Pace:&nbsp;<span class="pace"></span>/km</li>
                                    &mdash; <li>Ascent:&nbsp;<span class="ascent"></span>&nbsp;m</li>
                                </ul>
                            </footer>
                        {% endif %}
                    </section>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Disqus comments -->
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <hr>
                <h2>Comments</h2>
                <div class="comments">{{ render_disqus_comments() }}</div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block bottom %}
    {{ super() }}

    <!-- add the map -->
    {% if this.gpx or (this.latitude and this.longitude) %}
        <script src="{{ '/static/js/map.min.js'|asseturl }}" type="text/javascript"></script>
        <script type="text/javascript">
            // initialise the map
            init_map(document.getElementById("post-route"));
            add_fullscreen_control();
            {% if this.gpx %}
                // add the GPX route
                add_gpx(document.getElementById("post-route"), "{{ this.title }}");
            {% else %}
                // add the start point and view that
                add_marker("{{ this.title }}", "{{ this|url }}", "{{ this.date|dateformat('d MMMM y') }}", {{ this.latitude }}, {{ this.longitude }}, "{{ this.description }}");
                set_view({{ this.latitude }}, {{ this.longitude }}, {{ this.zoom }});
                set_title(document.getElementById("post-route"), "{{ this.title }}");
            {% endif %}
            
            // add photos with gps info to the map
            var photos = [];
            {% for image in this.attachments.images %}
                {% if image.exif.location %}
                    photos.push({
                        "lat": {{ image.exif.latitude }},
                        "lng": {{ image.exif.longitude }},
                        "thumbnail": "{{ image.thumbnail(64,64)|url }}",
                        "url": "{{ image|url }}",
                        "description": "{{ image.description }}",
                    });
                {% endif %}
            {% endfor %}
            add_photo_layer(photos);
        </script>
    {% endif %}

    <!-- fluid width for embedded videos (https://stackoverflow.com/a/33708979) -->
    <script type="text/javascript">
        $("iframe[src*='www.youtube.com']")
            .addClass("embed-responsive-item")
            .removeAttr('height')
            .removeAttr('width')
            .wrap("<div class='embed-responsive embed-responsive-16by9'/>");
    </script>

    <!-- All images - fluid width, title set to alt and click to view full size -->
    <script type="text/javascript">
        $("img")
            .addClass("img-fluid")
            .attr("title", function() {
                return $(this).attr("alt");
            })
            .wrap(function() {
                return $('<a />', {
                    "href": $(this).attr('src')
                });
            });
    </script>
{% endblock bottom %}
