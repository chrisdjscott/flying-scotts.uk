{% extends "layout.html" %}

{% block head %}
    {{ super() }}

    <!-- Leaflet CSS and JavaScript -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log==" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.3.1/gpx.min.js" type="text/javascript"></script>

    <!-- Custom map CSS -->
    <link href="{{ '/static/css/map.min.css'|asseturl }}" rel="stylesheet">
{% endblock head %}

{% block background %}{{ this.image|url }}{% endblock %}

{% block heading %}
    <div class="post-heading">
        <h1>{{ this.title }}</h1>
        <h2 class="subheading">{% if this.description %}{{ this.description }}{% endif %}</h2>
        <span class="meta">{% if this.date %}{{ this.date|dateformat('d MMMM y') }}{% endif %}</span>
    </div>
{% endblock heading %}

{% block content %}
    {{ super() }}

    {% if this.gpx or (this.latitude and this.longitude) %}
        <!-- Map of the route -->
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-10 mx-auto">
                    <hr>
                    <section id="post-route" class="gpx" {% if this.gpx %}data-gpx-source="{{ this.gpx|url }}" {% endif %}data-map-target="post-map">
                        <header>
                            <h3>Loading...</h3>
                            <span class="start"></span>
                        </header>

                        <article>
                            <div class="map" id="post-map"></div>
                        </article>

                        {% if this.gpx %}
                            <footer>
                                <ul class="info">
                                    <li>Distance:&nbsp;<span class="distance"></span>&nbsp;km</li>
                                    &mdash; <li>Elapsed:&nbsp;<span class="elapsed"></span></li>
                                    &mdash; <li>Moving:&nbsp;<span class="moving"></span></li>
                                    &mdash; <li>Pace:&nbsp;<span class="pace"></span>/km</li>
                                    &mdash; <li>Ascent:&nbsp;<span class="ascent"></span>&nbsp;m</li>
                                </ul>
                            </footer>
                        {% endif %}
                    </section>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Modal for images -->
    <div class="modal fade" id="enlargeImageModal" tabindex="-1" role="dialog" aria-labelledby="enlargeImageModal" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">Ã—</span></button>
                </div>
                <div class="modal-body">
                    <img src="" class="enlargeImageModalSource" style="width: 100%;">
                </div>
            </div>
        </div>
    </div>

    <!-- Disqus comments -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-md-10 mx-auto">
                <hr>
                <h2>Comments</h2>
                <div class="comments">{{ render_disqus_comments() }}</div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block bottom %}
    {{ super() }}

    <!-- add the map -->
    {% if this.gpx or (this.latitude and this.longitude) %}
        <script src="{{ '/static/js/map.min.js'|asseturl }}" type="text/javascript"></script>
        <script type="text/javascript">
            init_map(document.getElementById("post-route"));
            {% if this.gpx %}
                add_gpx(document.getElementById("post-route"), "{{ this.title }}");
            {% else %}
                add_marker("{{ this.title }}", "{{ this|url }}", "{{ this.date|dateformat('d MMMM y') }}", {{ this.latitude }}, {{ this.longitude }}, "{{ this.description }}");
                set_view({{ this.latitude }}, {{ this.longitude }}, {{ this.zoom }});
                set_title(document.getElementById("post-route"), "{{ this.title }}");
            {% endif %}
        </script>
    {% endif %}

    <!-- fluid width for embedded videos (https://stackoverflow.com/a/33708979) -->
    <script type="text/javascript">
        $("iframe[src*='www.youtube.com']")
            .addClass("embed-responsive-item")
            .removeAttr('height')
            .removeAttr('width')
            .wrap("<div class='embed-responsive embed-responsive-16by9'/>");
    </script>

    <!-- Google Photos - fluid width, centred and modal popup -->
    <script type="text/javascript">
        $("img[src*='googleusercontent.com']")
            .addClass("img-fluid")
            .css({ cursor: 'zoom-in', display: 'block',  margin: '0 auto' })
            .on('click', function() {
                $('.enlargeImageModalSource').attr('src', $(this).attr('src'));
                $('#enlargeImageModal').modal('show');
            });
    </script>
{% endblock bottom %}
